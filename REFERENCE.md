# Reference
<!-- DO NOT EDIT: This document was generated by Puppet Strings -->

## Table of Contents

**Classes**

* [`iptables`](#iptables): Add management of iptables with default rule optimization and a failsafe fallback mode  This class will detect conflicts with the SIMP option
* [`iptables::firewalld::shim`](#iptablesfirewalldshim): This is a `firewalld` profile that sets "safe" defaults as is usual in SIMP modules.  If you want to override any element not present in the 
* [`iptables::install`](#iptablesinstall): **NOTE: THIS IS A [PRIVATE](https://github.com/puppetlabs/puppetlabs-stdlib#assert_private) CLASS**  Install the IPTables and IP6Tables compo
* [`iptables::rules::base`](#iptablesrulesbase): **NOTE: THIS IS A [PRIVATE](https://github.com/puppetlabs/puppetlabs-stdlib#assert_private) CLASS**  Set up the basic iptables rules pertinen
* [`iptables::rules::default_drop`](#iptablesrulesdefault_drop): **NOTE: THIS IS A [PRIVATE](https://github.com/puppetlabs/puppetlabs-stdlib#assert_private) CLASS**  Manage the default policy settings of th
* [`iptables::rules::mod_recent`](#iptablesrulesmod_recent): A wrapper for managing the xt_recent portion of iptables settings  It is mainly meant to be a helper class but can be used alone if required.
* [`iptables::rules::prevent_localhost_spoofing`](#iptablesrulesprevent_localhost_spoofing): Add rules that prevent external parties from being able to send spoofed packets to your system from ::1  The sysctl setting for rp_filter han
* [`iptables::rules::scanblock`](#iptablesrulesscanblock): Provide a method for setting up an iptables electric fence  Any host that makes it past all of your allow rules will be added to the ban list
* [`iptables::service`](#iptablesservice): Manage the IPTables and IP6Tables services

**Defined types**

* [`iptables::firewalld::rule`](#iptablesfirewalldrule): Add firewall rules via firewalld  This is primarily meant for use with the iptables::listen::* defined types. If you wish to do direct manipu
* [`iptables::listen::all`](#iptableslistenall): Allow all protocols to all ports from a select set of networks
* [`iptables::listen::icmp`](#iptableslistenicmp): This provides a simple way to allow ICMP ports into the system.
* [`iptables::listen::tcp_stateful`](#iptableslistentcp_stateful): Allow access to specific ports from specific hosts or networks
* [`iptables::listen::udp`](#iptableslistenudp): Expose UDP ports to a set of hosts
* [`iptables::ports`](#iptablesports): A define to allow for the standardization of the  iptables::ports syntax across modules
* [`iptables::rule`](#iptablesrule): Add rules to the IPTables configuration file   ### Result:   *filter  :INPUT DROP [0:0]  :FORWARD DROP [0:0]  :OUTPUT ACCEPT [0:0]  :LOCAL-IN

**Resource types**

* [`ip6tables_optimize`](#ip6tables_optimize): A name variable, doesn't really do anything
* [`iptables_default_policy`](#iptables_default_policy): Manage the default policy on iptables tables built-in chains
* [`iptables_optimize`](#iptables_optimize): The path to the target file to be optimized. Mainly used for ensuring that the file comes after the optimization.
* [`iptables_rule`](#iptables_rule): Authoritatively manage iptables rules.  This type is atomic, either all rules work, or the old rules are preserved.
* [`xt_recent`](#xt_recent): Sets the various options on the running xt_recent kernel module.  If the module needs to be loaded, attempts to load the module.

**Functions**

* [`iptables::slice_ports`](#iptablesslice_ports): Split a stringified Iptables::DestPort into an Array that contain groupings of `max_length` size.
* [`iptables::use_firewalld`](#iptablesuse_firewalld): Returns ``true`` if the client can/should use firewalld

**Data types**

* [`Iptables::ApplyTo`](#iptablesapplyto): Valid families to which rules should apply
* [`Iptables::DestPort`](#iptablesdestport): An ``iptables_rule`` compatible port range or Array
* [`Iptables::PortRange`](#iptablesportrange): An iptables-compatible Port Range

## Classes

### iptables

Add management of iptables with default rule optimization and a failsafe
fallback mode

This class will detect conflicts with the SIMP option
``simp_options::firewall`` and, if necessary, cease management of IPTables in
the case of a conflict.

In particular, this means that if ``simp_options::firewall`` is ``false``,
but you have included this class, it will refuse to manage IPTables and will
instead raise a warning.

If the ``simp_options::firewall`` variable is not present, the module will
manage IPTables as expected.

#### Parameters

The following parameters are available in the `iptables` class.

##### `enable`

Data type: `Variant[Enum['ignore','firewalld'],Boolean]`

Enable IPTables

* If set to ``false`` will **disable** IPTables completely
* If set to ``ignore`` will stop managing IPTables

Default value: simplib::lookup('simp_options::firewall', { 'default_value' => true })

##### `use_firewalld`

Data type: `Boolean`

**EXPERIMENTAL** Enable the firewalld-passthrough capabilties

Default value: iptables::use_firewalld($enable)

##### `ensure`

Data type: `String`

The state that the ``package`` resources should target

* May take any value acceptable to the native ``package`` resource
  ``ensure`` parameter

Default value: simplib::lookup('simp_options::package_ensure', { 'default_value' => 'installed' })

##### `ipv6`

Data type: `Boolean`

Also manage IP6Tables

Default value: `true`

##### `class_debug`

Data type: `Boolean`

Print messages regarding rule comparisons

Default value: `false`

##### `optimize_rules`

Data type: `Boolean`

Run the inbuilt iptables rule optimizer to collapse the rules down to as
small as is reasonably possible without reordering

* IPsets will be eventually be incorporated

Default value: `true`

##### `ignore`

Data type: `Array[String[1]]`

Regular expressions that you would like to match in order to preserve
running rules

* This modifies the behavior of the ``iptables_optimize`` Type.
* Do **not** include the beginning and ending ``/`` but **do** include an
  end or beginning of word marker (``^`` and/or ``$``) if appropriate

Default value: []

##### `default_rules`

Data type: `Boolean`

Enable the usual set of default deny rules that you would expect to see on
most systems

* Uses the following expectations of rule ordering (not enforced):
    * 1     -> ``ESTABLISHED`` and ``RELATED`` rules
    * 2-5   -> Standard ``ACCEPT`` and ``DENY`` rules
    * 6-10  -> ``JUMP`` to other rule sets
    * 11-20 -> Pure ``ACCEPT`` rules
    * 22-30 -> ``LOG`` and ``REJECT`` rules

Default value: `true`

##### `scanblock`

Data type: `Boolean`

Enable a technique for setting up port-based triggers that will block
anyone connecting to the system for an hour after connection to a forbidden
port

Default value: `false`

##### `prevent_localhost_spoofing`

Data type: `Boolean`

Add rules to ``PREROUTING`` that will prevent spoofed packets from
``localhost`` addresses from reaching your system

Default value: `true`

##### `ports`

Data type: `Optional[Hash]`

A hash with structure as defined below that will open ports based on the
structure of the hash.
@example An example section of hieradata:
  iptables::ports:
    defaults:
      apply_to: ipv4
    80:
    53:
      proto: udp
    443:
      apply_to: ipv6

Default value: `undef`

### iptables::firewalld::shim

This is a `firewalld` profile that sets "safe" defaults as is usual in SIMP
modules.

If you want to override any element not present in the `firewalld` class
resource below then you should use Hiera directly on the `firewalld` class.

## Class Resources

The following class resources are used in this code:
  - firewalld

#### Parameters

The following parameters are available in the `iptables::firewalld::shim` class.

##### `enable`

Data type: `Boolean`

Activate the firewalld shim capabilties.

Default value: `true`

##### `complete_reload`

Data type: `Boolean`

The current firewalld module has the capability to perform a complete reload
of firewalld which breaks any existing connections. This is extremely
dangerous and this class overrides and disables this capability by default.

* Set to ``true`` to re-enable this capability.

Default value: `false`

##### `lockdown`

Data type: `Boolean`

Set ``firewalld`` in ``lockdown`` mode which disallows manipulation by
applications.

* This makes sense to do by default since puppet is meant to be
  authoritative on the system.

Default value: `true`

##### `default_zone`

Data type: `String[1]`

The 'default zone' to set on the system.

This is set to ``99_simp`` so that regular, alternative, zone manipulation
can occur without interference.

**IMPORTANT:** If this is set to anything besides ``99_simp``, all rules in
this module will **NOT** apply to the default zone! This module is set to
only populate ``99_simp`` zone rules.

Default value: '99_simp'

##### `log_denied`

Data type: `Enum['off', 'all','unicast','broadcast','multicast']`

What types of logs to process for denied packets.

@see LogDenied in firewalld.conf(5)

Default value: 'unicast'

##### `firewall_backend`

Data type: `Enum['iptables','nftables']`

Allows you to set the backend that firewalld will use.

* Currently set to 'iptables' due to bugs in nftables

Default value: 'iptables'

##### `enable_tidy`

Data type: `Boolean`

Enable the ``Tidy`` resources that help keep the system clean from cruft

Default value: `true`

##### `tidy_dirs`

Data type: `Array[Stdlib::Absolutepath]`

The directories to target for tidying

Default value: [
                                                                                 '/etc/firewalld/icmptypes',
                                                                                 '/etc/firewalld/ipsets',
                                                                                 '/etc/firewalld/services'
                                                                               ]

##### `tidy_prefix`

Data type: `String[1]`

The name match to use for tidying files

Default value: 'simp_'

##### `tidy_minutes`

Data type: `Integer[1]`

Number of **minutes** to consider a configuration file 'stale' for the
purposes of tidying.

Default value: 10

##### `simp_zone_interfaces`

Data type: `Array[Optional[String[1]]]`

The network interfaces to which the underlying 99_simp zone should apply

Default value: []

##### `simp_zone_target`

Data type: `Enum['default', 'ACCEPT', 'REJECT', 'DROP']`

The default target for the 99_simp zone

Default value: 'DROP'

### iptables::install

**NOTE: THIS IS A [PRIVATE](https://github.com/puppetlabs/puppetlabs-stdlib#assert_private) CLASS**

Install the IPTables and IP6Tables components

This also installs fallback startup scripts that come into play should the
regular processes fail to start due to a race consition with DNS.

### iptables::rules::base

**NOTE: THIS IS A [PRIVATE](https://github.com/puppetlabs/puppetlabs-stdlib#assert_private) CLASS**

Set up the basic iptables rules pertinent to system security

The rules defined in here follow the following suggestion:
* 1     -> ESTABLISHED,RELATED rules.
* 2-5   -> Standard ACCEPT/DENY rules.
* 6-10  -> Jumps to other rule sets.
* 11-20 -> Pure accept rules.
* 22-30 -> Logging and rejection rules.

#### Parameters

The following parameters are available in the `iptables::rules::base` class.

##### `allow_ping`

Data type: `Boolean`

Allow ICMP type 8 (ping) packets into the host

* This is enabled by default for RFC 1122 compliance

@see https://tools.ietf.org/html/rfc1122#page-42 RFC 1122 Section 3.2.2.6

Default value: `true`

##### `drop_broadcast`

Data type: `Boolean`

Drop all broadcast traffic to this host

Default value: `true`

##### `drop_loopback`

Data type: `Boolean`

Drop all loopback traffic to this host

@see https://tools.ietf.org/html/rfc1122#page-31 RFC 1122 Section 3.2.1.3(g)

Default value: `true`

##### `drop_multicast`

Data type: `Boolean`

Drop all multicast traffic to this host

Default value: `true`

##### `force_local_input`

Data type: `Boolean`

Require that all traffic traverse the LOCAL-INPUT chain

* If set to `false`, will put LOCAL-INPUT at the bottom of the INPUT
  traversal stack so that other chains may easily be added above.

Default value: `true`

### iptables::rules::default_drop

**NOTE: THIS IS A [PRIVATE](https://github.com/puppetlabs/puppetlabs-stdlib#assert_private) CLASS**

Manage the default policy settings of the built in chains.

Given that there is a well-defined, and limited, set of built-in chains this
class fully enumerates the combinations to maximize readability.

* Setting any parameter to `true` will activate the DROP condition.
* Setting any parameter to `false` will activate the ACCEPT condition.
* Leaving a parameter unset will not change the state of the system.

NOTE: If you need different settings for IPv6 and IPv4 then you will need to
create your own resources

#### Parameters

The following parameters are available in the `iptables::rules::default_drop` class.

##### `filter_input`

Data type: `Optional[Boolean]`



Default value: `undef`

##### `filter_forward`

Data type: `Optional[Boolean]`



Default value: `undef`

##### `filter_output`

Data type: `Optional[Boolean]`



Default value: `undef`

### iptables::rules::mod_recent

A wrapper for managing the xt_recent portion of iptables settings

It is mainly meant to be a helper class but can be used alone if
required.

#### Parameters

The following parameters are available in the `iptables::rules::mod_recent` class.

##### `notify_iptables`

Data type: `Boolean`

Notify the IPTables service when complete

Default value: `true`

##### `ip_list_tot`

Data type: `Integer[0]`

The number of addresses remembered per table

*This effectively becomes the maximum size of your ban list
* Be aware that more addresses means more load on your system

Default value: 200

##### `ip_pkt_list_tot`

Data type: `Integer[0]`

The number of packets per address remembered

Default value: 20

##### `ip_list_hash_size`

Data type: `Integer[0]`

Hash table size

* 0 means to calculate it based on ``ip_list_tot``

Default value: 0

##### `ip_list_perms`

Data type: `String`

Permissions for ``/proc/net/xt_recent/*`` files

Default value: '0640'

##### `ip_list_uid`

Data type: `Integer[0]`

Numerical UID for ownership of ``/proc/net/xt_recent/*`` files

Default value: 0

##### `ip_list_gid`

Data type: `Integer[0]`

Numerical GID for ownership of ``/proc/net/xt_recent/*`` files

Default value: 0

### iptables::rules::prevent_localhost_spoofing

Add rules that prevent external parties from being able to send spoofed
packets to your system from ::1

The sysctl setting for rp_filter handles this for IPv4

### iptables::rules::scanblock

Provide a method for setting up an iptables electric fence

Any host that makes it past all of your allow rules will be
added to the ban list.

------------------------------------------------------------------------

> **WARNING**
>
> If you enable this, be sure to enable your IPTables rules prior to
> connecting with a client or you're likely to **completely deny** your
> internal hosts.
>
> **WARNING**

------------------------------------------------------------------------

**NOTE:** Changing **any** of the ``ip_*`` variables will cause the iptables
service to be triggered. This is because the variables cannot take
effect until the iptables rules are reset.

## Management

Details on managing xt_recent can be found in ``iptables(8)``. The following
are just some useful commands.

* Add address to list
  ``echo +addr >/proc/net/xt_recent/LIST_NAME``

* Remove address from list
  ``echo -addr >/proc/net/xt_recent/LIST_NAME``

* Remove all address from list
  ``echo / >/proc/net/xt_recent/LIST_NAME``

* **See also**
http://www.thatsgeeky.com/2011/01/limiting-brute-force-attacks-with-iptables/
Limiting Brute Force Attacks with IPTables

#### Parameters

The following parameters are available in the `iptables::rules::scanblock` class.

##### `enable`

Data type: `Boolean`

Enable or disable scan blocking

Default value: `true`

##### `seconds`

Data type: `Integer[0]`

Connections from attackers must happen within this number of seconds to be
considered an attack

* Directly relates to hitcount to log and block attackers

Default value: 60

##### `hitcount`

Data type: `Integer[0]`

The number of hits that must happen within 'seconds' to be considered an
attack

Default value: 2

##### `set_rttl`

Data type: `Boolean`

Set this if you worry about having external parties DoS your system by
spoofing their IP addresses

Default value: `false`

##### `update_interval`

Data type: `Integer[0]`

Block attackers for this long (in seconds)

* Connecting systems must not connect for at least this long prior to being
  allowed to reconnect

Default value: 3600

##### `logs_per_minute`

Data type: `Integer[0]`

How many logs to send given logs_per_minute connections per minute

* This is mainly so that you don't end up overrunning your log services

Default value: 5

##### `ip_list_tot`

Data type: `Integer[0]`

The number of addresses remembered per table

* This effectively becomes the maximum size of your block list
* **NOTE:** Be aware that more addresses means more load on your system

Default value: 200

##### `ip_pkt_list_tot`

Data type: `Integer[0]`

The number of packets per address remembered

Default value: 20

##### `ip_list_hash_size`

Data type: `Integer[0]`

Hash table size

* ``0`` means to calculate it based on ``ip_list_tot``

Default value: 0

##### `ip_list_perms`

Data type: `String`

Permissions for ``/proc/net/xt_recent/*`` files

Default value: '0640'

##### `ip_list_uid`

Data type: `Integer[0]`

Numerical ``UID`` for ownership of ``/proc/net/xt_recent/*`` files

Default value: 0

##### `ip_list_gid`

Data type: `Integer[0]`

Numerical ``GID`` for ownership of ``/proc/net/xt_recent/*`` files

Default value: 0

### iptables::service

Manage the IPTables and IP6Tables services

#### Parameters

The following parameters are available in the `iptables::service` class.

##### `enable`

Data type: `Any`

Enable IPTables

* If set to ``false`` with **disable** IPTables completely
* If set to ``ignore`` will stop managing IPTables

Default value: pick(getvar('iptables::enable'),true)

##### `ipv6`

Data type: `Any`

Also manage IP6Tables

Default value: pick(getvar('iptables::ipv6'),true)

## Defined types

### iptables::firewalld::rule

Add firewall rules via firewalld

This is primarily meant for use with the iptables::listen::* defined types.
If you wish to do direct manipulation of firewalld rules it is recommended
that you use the Hiera-native capabilities of the firewalld module directly.

#### Parameters

The following parameters are available in the `iptables::firewalld::rule` defined type.

##### `trusted_nets`

Data type: `Simplib::Netlist`

The networks/hosts to which the rule applies

##### `protocol`

Data type: `Enum['icmp','tcp','udp','all']`

The network protocol to which the rule applies

##### `dports`

Data type: `Optional[Iptables::DestPort]`

The ports to which the rule applies

Default value: `undef`

##### `icmp_blocks`

Data type: `Optional[Variant[Array[String],String]]`

The ICMP Blocks to which the rule applies

Default value: `undef`

##### `order`

Data type: `Integer[0]`

The order in which the rule should appear

Due to the way firewalld works, this may not do what you expect unless the
version of firewalld explicitly supports it.

* 1 is the minimum and 9999999 is the maximum

* The following ordering ranges are suggested (but not enforced):

    * 1     -> ESTABLISHED,RELATED rules
    * 2-5   -> Standard ACCEPT/DENY rules
    * 6-10  -> Jumps to other rule sets
    * 11-20 -> Pure accept rules
    * 22-30 -> Logging and rejection rules

Default value: 11

##### `apply_to`

Data type: `Iptables::ApplyTo`

The address family to which to apply this rule

* ipv4 -> iptables
* ipv6 -> ip6tables
* all  -> Both
* auto -> Try to figure it out from the rule, defaults to ``all``

Default value: 'auto'

### iptables::listen::all

Allow all protocols to all ports from a select set of networks

#### Examples

##### Open Access to Hosts ```1.2.3.4`` and ``5.6.7.8``

```puppet
iptables::listen::all { 'example':
  trusted_nets => [ '1.2.3.4', '5.6.7.8' ],
}

### Result

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:LOCAL-INPUT - [0:0]
-A INPUT -j LOCAL-INPUT
-A FORWARD -j LOCAL-INPUT
-A LOCAL-INPUT -p icmp --icmp-type 8 -j ACCEPT
-A LOCAL-INPUT -i lo -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A LOCAL-INPUT -s 1.2.3.4 -j ACCEPT
-A LOCAL-INPUT -s 5.6.7.8 -j ACCEPT
-A LOCAL-INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A LOCAL-INPUT -j LOG --log-prefix "IPT:"
-A LOCAL-INPUT -j DROP
COMMIT
```

#### Parameters

The following parameters are available in the `iptables::listen::all` defined type.

##### `first`

Data type: `Boolean`

Prepend this rule to the rule set

Default value: `false`

##### `absolute`

Data type: `Boolean`

Make sure that this rule is absolutely first, or last, depending on the
setting of ``first``

* If ``first`` is true, this rule will be at the top of the list
* If ``first`` is false, this rule will be at the bottom of the list
* For all ``absolute`` rules, alphabetical sorting still takes place

Default value: `false`

##### `order`

Data type: `Integer[0]`

The order in which the rule should appear

* 1 is the minimum and 9999999 is the maximum

* The following ordering ranges are suggested (but not enforced):

    * 1     -> ESTABLISHED,RELATED rules
    * 2-5   -> Standard ACCEPT/DENY rules
    * 6-10  -> Jumps to other rule sets
    * 11-20 -> Pure accept rules
    * 22-30 -> Logging and rejection rules

Default value: 11

##### `apply_to`

Data type: `Iptables::ApplyTo`

The IPTables network type to which to apply this rule

* ipv4 -> iptables
* ipv6 -> ip6tables
* all  -> Both
* auto -> Try to figure it out from the rule, will **not** pick ``all``

Default value: 'auto'

##### `trusted_nets`

Data type: `Simplib::Netlist`

Client networks that should be allowed

Set to ``any`` to allow all networks

Default value: simplib::lookup('simp_options::trusted_nets', { 'default_value' => ['127.0.0.1'] })

### iptables::listen::icmp

This provides a simple way to allow ICMP ports into the system.

* **See also**
iptables(8)

#### Examples

##### Allow ``ping`` From ``1.2.3.4`` and ``5.6.7.8``

```puppet
iptables::listen::icmp { "example":
  trusted_nets => [ "1.2.3.4", "5.6.7.8" ],
  icmp_type => '8'
}

### Result

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:LOCAL-INPUT - [0:0]
-A INPUT -j LOCAL-INPUT
-A FORWARD -j LOCAL-INPUT
-A LOCAL-INPUT -p icmp --icmp-type 8 -j ACCEPT
-A LOCAL-INPUT -i lo -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A LOCAL-INPUT -p icmp -s 1.2.3.4 --icmp-type 8 -j ACCEPT
-A LOCAL-INPUT -p icmp -s 5.6.7.8 --icmp-type 8 -j ACCEPT
-A LOCAL-INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A LOCAL-INPUT -j LOG --log-prefix "IPT:"
-A LOCAL-INPUT -j DROP
COMMIT
```

#### Parameters

The following parameters are available in the `iptables::listen::icmp` defined type.

##### `icmp_types`

Data type: `Variant[Array[String],String]`

The iptables-compatible ICMP types that should be allowed

* You can list the ICMP types with ``iptables -p icmp -h``
* Set to ``any`` to allow **all** ICMP types

##### `first`

Data type: `Boolean`

Prepend this rule to the rule set

Default value: `false`

##### `absolute`

Data type: `Boolean`

Make sure that this rule is absolutely first, or last, depending on the
setting of ``first``

* If ``first`` is true, this rule will be at the top of the list
* If ``first`` is false, this rule will be at the bottom of the list
* For all ``absolute`` rules, alphabetical sorting still takes place

Default value: `false`

##### `order`

Data type: `Integer[0]`

The order in which the rule should appear

* 1 is the minimum and 9999999 is the maximum

* The following ordering ranges are suggested (but not enforced):

    * 1     -> ESTABLISHED,RELATED rules
    * 2-5   -> Standard ACCEPT/DENY rules
    * 6-10  -> Jumps to other rule sets
    * 11-20 -> Pure accept rules
    * 22-30 -> Logging and rejection rules

Default value: 11

##### `apply_to`

Data type: `Iptables::ApplyTo`

The IPTables network type to which to apply this rule

* ipv4 -> iptables
* ipv6 -> ip6tables
* all  -> Both
* auto -> Try to figure it out from the rule, will **not** pick ``all``

Default value: 'auto'

##### `trusted_nets`

Data type: `Simplib::Netlist`

Client networks that should be allowed

Set to ``any`` to allow all networks

Default value: simplib::lookup('simp_options::trusted_nets', { 'default_value' => ['127.0.0.1'] })

### iptables::listen::tcp_stateful

Allow access to specific ports from specific hosts or networks

#### Examples

##### Provide Access to Specific Ports

```puppet
iptables::listen::tcp_stateful { 'example':
  trusted_nets => [ '1.2.3.4', '5.6.7.8' ],
  dports => [ 5, '1024:65535' ]
}

### Result

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:LOCAL-INPUT - [0:0]
-A INPUT -j LOCAL-INPUT
-A FORWARD -j LOCAL-INPUT
-A LOCAL-INPUT -p icmp --icmp-type 8 -j ACCEPT
-A LOCAL-INPUT -i lo -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp -s 1.2.3.4 --dport 5 -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp -s 5.6.7.8 --dport 5 -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp -s 1.2.3.4 --dport 1024:65535 -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp -s 5.6.7.8 --dport 1024:65535 -j ACCEPT
-A LOCAL-INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A LOCAL-INPUT -j LOG --log-prefix "IPT:"
-A LOCAL-INPUT -j DROP
COMMIT
```

#### Parameters

The following parameters are available in the `iptables::listen::tcp_stateful` defined type.

##### `dports`

Data type: `Iptables::DestPort`

The ports that you want to expose

##### `first`

Data type: `Boolean`

Prepend this rule to the rule set

Default value: `false`

##### `absolute`

Data type: `Boolean`

Make sure that this rule is absolutely first, or last, depending on the
setting of ``first``

* If ``first`` is true, this rule will be at the top of the list
* If ``first`` is false, this rule will be at the bottom of the list
* For all ``absolute`` rules, alphabetical sorting still takes place

Default value: `false`

##### `order`

Data type: `Integer[0]`

The order in which the rule should appear

* 1 is the minimum and 9999999 is the maximum

* The following ordering ranges are suggested (but not enforced):

    * 1     -> ESTABLISHED,RELATED rules
    * 2-5   -> Standard ACCEPT/DENY rules
    * 6-10  -> Jumps to other rule sets
    * 11-20 -> Pure accept rules
    * 22-30 -> Logging and rejection rules

Default value: 11

##### `apply_to`

Data type: `Iptables::ApplyTo`

The IPTables network type to which to apply this rule

* ipv4 -> iptables
* ipv6 -> ip6tables
* all  -> Both
* auto -> Try to figure it out from the rule, will **not** pick ``all``

Default value: 'auto'

##### `trusted_nets`

Data type: `Simplib::Netlist`

Client networks that should be allowed

Set to ``any`` to allow all networks

Default value: simplib::lookup('simp_options::trusted_nets', { 'default_value' => ['127.0.0.1'] })

### iptables::listen::udp

Expose UDP ports to a set of hosts

#### Examples

##### Allow UDP Access to ``1.2.3.4`` and ``5.6.7.8``

```puppet
iptables::listen::udp { 'example':
  trusted_nets => [ '1.2.3.4', '5.6.7.8' ],
  dports       => [ 5, '1024:65535' ]
}

### Result

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:LOCAL-INPUT - [0:0]
-A INPUT -j LOCAL-INPUT
-A FORWARD -j LOCAL-INPUT
-A LOCAL-INPUT -p icmp --icmp-type 8 -j ACCEPT
-A LOCAL-INPUT -i lo -j ACCEPT
-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A LOCAL-INPUT -p udp -s 1.2.3.4 --dport 5 -j ACCEPT
-A LOCAL-INPUT -p udp -s 5.6.7.8 --dport 5 -j ACCEPT
-A LOCAL-INPUT -p udp -s 1.2.3.4 --dport 1024:65535 -j ACCEPT
-A LOCAL-INPUT -p udp -s 5.6.7.8 --dport 1024:65535 -j ACCEPT
-A LOCAL-INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A LOCAL-INPUT -j LOG --log-prefix "IPT:"
-A LOCAL-INPUT -j DROP
COMMIT
```

#### Parameters

The following parameters are available in the `iptables::listen::udp` defined type.

##### `dports`

Data type: `Iptables::DestPort`

The ports that you want to expose

##### `first`

Data type: `Boolean`

Prepend this rule to the rule set

Default value: `false`

##### `absolute`

Data type: `Boolean`

Make sure that this rule is absolutely first, or last, depending on the
setting of ``first``

* If ``first`` is true, this rule will be at the top of the list
* If ``first`` is false, this rule will be at the bottom of the list
* For all ``absolute`` rules, alphabetical sorting still takes place

Default value: `false`

##### `order`

Data type: `Integer[0]`

The order in which the rule should appear

* 1 is the minimum and 9999999 is the maximum

* The following ordering ranges are suggested (but not enforced):

    * 1     -> ESTABLISHED,RELATED rules
    * 2-5   -> Standard ACCEPT/DENY rules
    * 6-10  -> Jumps to other rule sets
    * 11-20 -> Pure accept rules
    * 22-30 -> Logging and rejection rules

Default value: 11

##### `apply_to`

Data type: `Iptables::ApplyTo`

The IPTables network type to which to apply this rule

* ipv4 -> iptables
* ipv6 -> ip6tables
* all  -> Both
* auto -> Try to figure it out from the rule, will **not** pick ``all``

Default value: 'auto'

##### `trusted_nets`

Data type: `Simplib::Netlist`

Client networks that should be allowed

Set to ``any`` to allow all networks

Default value: simplib::lookup('simp_options::trusted_nets', { 'default_value' => ['127.0.0.1'] })

### iptables::ports

A define to allow for the standardization of the
 iptables::ports syntax across modules

#### Parameters

The following parameters are available in the `iptables::ports` defined type.

##### `ports`

Data type: `Hash`

A hash with structure as defined below that will open ports based on the
structure of the hash.
@example An example section of hieradata:
  iptables::ports:
    defaults:
      apply_to: ipv4
    80:
    53:
      proto: udp
    443:
      apply_to: ipv6
    514:
      proto:
        - udp
        - tcp

### iptables::rule

Add rules to the IPTables configuration file

 ### Result:

 *filter
 :INPUT DROP [0:0]
 :FORWARD DROP [0:0]
 :OUTPUT ACCEPT [0:0]
 :LOCAL-INPUT - [0:0]
 -A INPUT -j LOCAL-INPUT
 -A FORWARD -j LOCAL-INPUT
 -A LOCAL-INPUT -p icmp --icmp-type 8 -j ACCEPT
 -A LOCAL-INPUT -i lo -j ACCEPT
 -A LOCAL-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
 -A LOCAL-INPUT -m state --state NEW -m tcp -p tcp -s 1.2.3.4 --dport 1024:65535 -j ACCEPT
 -A LOCAL-INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
 -A LOCAL-INPUT -j LOG --log-prefix "IPT:"
 -A LOCAL-INPUT -j DROP
 COMMIT

#### Examples

##### Add a TCP Allow Rule

```puppet
iptables::rule { 'example':
  content => '-A LOCAL-INPUT -m state --state NEW -m tcp -p tcp -s 1.2.3.4 --dport 1024:65535 -j ACCEPT'
}
```

#### Parameters

The following parameters are available in the `iptables::rule` defined type.

##### `content`

Data type: `String`

The **exact** content of the rule that should be added

##### `table`

Data type: `String`

The name of the table you are adding to

* Usual names include (but are not limited to):

    * filter
    * mangle
    * nat
    * raw
    * security

Default value: 'filter'

##### `first`

Data type: `Boolean`

Prepend this rule to the rule set

Default value: `false`

##### `absolute`

Data type: `Boolean`

Make sure that this rule is absolutely first, or last, depending on the
setting of ``first``

* If ``first`` is true, this rule will be at the top of the list
* If ``first`` is false, this rule will be at the bottom of the list
* For all ``absolute`` rules, alphabetical sorting still takes place

Default value: `false`

##### `order`

Data type: `Integer[0]`

The order in which the rule should appear

* 1 is the minimum and 9999999 is the maximum

* The following ordering ranges are suggested (but not enforced):

    * 1     -> ESTABLISHED,RELATED rules
    * 2-5   -> Standard ACCEPT/DENY rules
    * 6-10  -> Jumps to other rule sets
    * 11-20 -> Pure accept rules
    * 22-30 -> Logging and rejection rules

Default value: 11

##### `header`

Data type: `Boolean`

Automatically add the line header ``-A LOCAL-INPUT``

Default value: `true`

##### `apply_to`

Data type: `Iptables::ApplyTo`

The IPTables network type to which to apply this rule

* ipv4 -> iptables
* ipv6 -> ip6tables
* all  -> Both
* auto -> Try to figure it out from the rule, will **not** pick ``all``

Default value: 'auto'

## Resource types

### ip6tables_optimize

A name variable, doesn't really do anything

#### Properties

The following properties are available in the `ip6tables_optimize` type.

##### `optimize`

Valid values: `true`, `false`

Whether or not to optimize

Default value: true

#### Parameters

The following parameters are available in the `ip6tables_optimize` type.

##### `name`

namevar

A name variable, doesn't really do anything

##### `disable`

Valid values: `true`, `false`

This is a way to authoritatively disable the application of the
iptables module.

Default value: `false`

##### `ignore`

Ignore all *running* iptables rules matching one or more provided Ruby
regexes. The regexes are compared against the jump and chain options, as
well as the interface name of the running rules and excluded from the
synchronization comparison against the new rules.

!!Do not include the beginning and ending slashes in your regular expressions.!!

NOTE: If a rule has been added or removed, this setting ignored and
ip6tables *will* be restarted! If you have services which are
affected by this, make sure that they subscribe to
Service['ip6tables'] and/or Service['ip6tables'] as appropriate.

Examples:
  # Preserve all rules whose chain begins with the word 'foo'
  ignore => '^foo'

  # Preserve all rules whose chain begins with the word 'foo' or
  # ends with the word 'bar'
  ignore => ['^foo','bar$']

### iptables_default_policy

Manage the default policy on iptables tables built-in chains

#### Properties

The following properties are available in the `iptables_default_policy` type.

##### `policy`

Valid values: ACCEPT, DROP, accept, drop

The IPTables JUMP policy to apply

Default value: DROP

#### Parameters

The following parameters are available in the `iptables_default_policy` type.

##### `name`

A name of the form <table>:<chain> to which the resource will be applied

##### `apply_to`

Valid values: ipv4, ipv6, all

What version(s) of iptables to which to apply this rule.
'all' is equivalent to ['ipv4', 'ipv6'] as appropriate.

Default value: all

##### `table`

namevar

The table that the chain belongs to

##### `chain`

namevar

The targeted chain

### iptables_optimize

The path to the target file to be optimized. Mainly used for ensuring that the file comes after the optimization.

#### Properties

The following properties are available in the `iptables_optimize` type.

##### `optimize`

Valid values: `true`, `false`

Whether or not to optimize

Default value: true

#### Parameters

The following parameters are available in the `iptables_optimize` type.

##### `name`

namevar

The path to the target file to be optimized. Mainly used for ensuring that the file comes after the optimization.

##### `disable`

Valid values: `true`, `false`

This is a way to authoritatively disable the application of the
iptables module.

Default value: `false`

##### `ignore`

Ignore all *running* iptables rules matching one or more provided Ruby
regexes. The regexes are compared against the jump and chain options, as
well as the interface name of the running rules and excluded from the
synchronization comparison against the new rules.

!!Do not include the beginning and ending slashes in your regular expressions.!!

NOTE: If a rule has been added or removed, this setting ignored and
iptables *will* be restarted! If you have services which are
affected by this, make sure that they subscribe to
Service['iptables'] and/or Service['ip6tables'] as appropriate.

Examples:
  # Preserve all rules whose jump or chain begins with the word 'foo'
  ignore => '^foo'

  # Preserve all rules whose jump or chain begins with the word 'foo' or
  # ends with the word 'bar'
  ignore => ['^foo','bar$']

### iptables_rule

Authoritatively manage iptables rules.  This type is
atomic, either all rules work, or the old rules are
preserved.

#### Properties

The following properties are available in the `iptables_rule` type.

##### `content`

Valid values: /\w+/

The content of the rule that should be added

#### Parameters

The following parameters are available in the `iptables_rule` type.

##### `name`

namevar

The name of the rule. Simply used for creating the unique fragments.

##### `include_comment`

Valid values: `true`, `false`, yes, no

Whether or not to include the value in the $comment paramter

Default value: `true`

##### `comment_header`

A header to prepend to all comments for easy visual rule tracking

Default value: SIMP:

##### `comment`

A comment to add to the rule.

The value of $comment_header will be prepended.

Empty comments (no content and no header) will be discarded.

Content will be truncated at 255 characters, including the header.

Default value: ""

##### `header`

Valid values: `true`, `false`

Whether or not to auto-include the table LOCAL-INPUT in
the rule.

Default value: `true`

##### `apply_to`

Valid values: ipv4, ipv6, all, auto

What version(s) of iptables to which to apply this rule.
If set to 'auto' (the default) then we'll try to guess
what you want and default to ['ipv4','ipv6'].

If 'auto' is set then each line will be evaluated as an
independent rule.
- Any rules that have IPv4 addresses will be applied to
  iptables.
- Any rules that have IPv6 addresses will be applied to
  ip6tables.
- All other rules will be applied to *both* utilities.
- If in doubt, split your rules and specify your tables!

Default value: auto

##### `table`

The name of the table that you are adding to.

Default value: filter

##### `first`

Valid values: `true`, `false`

Set to 'true' if you want to prepend your rule.

Default value: `false`

##### `absolute`

Valid values: `true`, `false`

Set to 'true' if you want the rule to be the absolute
first or last. This is relative and places items in
alphabetical order if multiple absolute first/lasts are
specified.

Default value: `false`

##### `order`

Valid values: /\d+/

The order in which the rule should appear. 1 is the
minimum and 999 is the max.

Default value: 11

##### `resolve`

Valid values: `true`, `false`

Whether or not to use DNS resolution to identify hostnames
in IPTables statements.

This should probably be left at :true since it is a rare
scenario and, should you use this, you will want the rule
to go into either iptables or ip6tables correctly.

With this enabled, the IP address that is resolved will be
added to IPTables and not the hostname itself.

Default value: `true`

### xt_recent

Sets the various options on the running xt_recent kernel module.

If the module needs to be loaded, attempts to load the module.

#### Properties

The following properties are available in the `xt_recent` type.

##### `ip_list_tot`

Valid values: /^\d+$/

The number of addresses remembered per table. This effectively
becomes the maximum size of your block list. Be aware that
more addresses means more load on your system.

Default value: 100

##### `ip_pkt_list_tot`

Valid values: /^\d+$/

The number of packets per address remembered.

Default value: 20

##### `ip_list_hash_size`

Valid values: /^\d+$/

Hash table size. 0 means to calculate it based on ip_list_tot.

Default value: 0

##### `ip_list_perms`

Valid values: /^[0-7]{4}$/

Permissions for /proc/net/xt_recent/* files.

Default value: 0640

##### `ip_list_uid`

Valid values: /^\d+$/

Numerical UID for ownership of /proc/net/xt_recent/* files.

Default value: 0

##### `ip_list_gid`

Valid values: /^\d+$/

Numerical GID for ownership of /proc/net/xt_recent/* files.

Default value: 0

#### Parameters

The following parameters are available in the `xt_recent` type.

##### `name`

namevar

The path to the xt_recent variables to be manipulated

## Functions

### iptables::slice_ports

Type: Ruby 4.x API

Split a stringified Iptables::DestPort into an Array that contain groupings
of `max_length` size.

#### `iptables::slice_ports(Variant[String,Array[String]] $input, Integer[1] $max_length)`

Split a stringified Iptables::DestPort into an Array that contain groupings
of `max_length` size.

Returns: `Array[Array[String]]` ]

##### `input`

Data type: `Variant[String,Array[String]]`

One or more ports or port ranges, all represented
as strings.

##### `max_length`

Data type: `Integer[1]`

The maximum length of each group.

### iptables::use_firewalld

Type: Puppet Language

Returns ``true`` if the client can/should use firewalld

#### `iptables::use_firewalld(Variant[String[1], Boolean] $enable = true)`

Returns ``true`` if the client can/should use firewalld

Returns: `Boolean`

##### `enable`

Data type: `Variant[String[1], Boolean]`

The type of enablement to use

* true      => Do the right thing based on the underlying OS
* false     => Return `false`
* firewalld => Force `firewalld` if available

## Data types

### Iptables::ApplyTo

Valid families to which rules should apply

Alias of `Enum['ipv4', 'ipv6', 'all', 'auto']`

### Iptables::DestPort

An ``iptables_rule`` compatible port range or Array

Alias of `Variant[Simplib::Port, Iptables::PortRange, Array[Variant[Simplib::Port, Iptables::PortRange]]]`

### Iptables::PortRange

An iptables-compatible Port Range

Alias of `Pattern['^([0-5]?\d?\d?\d?\d|6[0-4]\d\d\d|65[0-4]\d\d|655[0-2]\d|6553[0-5]):([0-5]?\d?\d?\d?\d|6[0-4]\d\d\d|65[0-4]\d\d|655[0-2]\d|6553[0-5])$']`

